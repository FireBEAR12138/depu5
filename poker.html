<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¾·å·æ‰‘å…‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #poker-table {
            width: 90vmin;
            height: 90vmin;
            position: relative;
            background: linear-gradient(145deg, #277234, #338f41);
            border-radius: 50%;
            border: 30px solid #2c1810;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5),
                        0 0 30px rgba(0,0,0,0.3);
        }

        .player {
            position: absolute;
            width: 150px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .player .name {
            font-size: 16px;
            margin-bottom: 3px;
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255,215,0,0.5);
        }

        .player .chips {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
        }

        .player.thinking {
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
            transform: scale(1.05);
        }

        .card {
            display: inline-block;
            width: 60px;
            height: 84px;
            background: #fff;
            border-radius: 5px;
            margin: 0 -10px;  /* é‡å æ•ˆæœ */
            text-align: center;
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            transform-origin: center bottom;
            cursor: default;
        }

        /* ç‰Œé¢å¸ƒå±€ */
        .card .rank {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .card .rank-bottom {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 16px;
            font-weight: bold;
            transform: rotate(180deg);
        }

        .card .suit {
            position: absolute;
            top: 22px;
            left: 5px;
            font-size: 16px;
        }

        .card .suit-bottom {
            position: absolute;
            bottom: 22px;
            right: 5px;
            font-size: 16px;
            transform: rotate(180deg);
        }

        .card .center-suit {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
        }

        /* ç‰ŒèƒŒè®¾è®¡ */
        .card.back {
            background: linear-gradient(135deg, #600, #900);
            position: relative;
            overflow: hidden;
        }

        .card.back::before {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .card.back::after {
            content: "â™ â™£â™¥â™¦";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: rgba(255,255,255,0.2);
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            white-space: nowrap;
        }

        /* æ‚¬æµ®æ•ˆæœ */
        .card:hover {
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* çº¢è‰²èŠ±è‰²æ ·å¼ */
        .card .red {
            color: #d40000;
        }

        /* é»‘è‰²èŠ±è‰²æ ·å¼ */
        .card .black {
            color: #000;
        }

        /* ç©å®¶æ‰‹ç‰ŒåŒºåŸŸ */
        .cards {
            display: flex;
            justify-content: center;
            padding: 0 15px;
            height: 90px;
        }

        /* å…¬å…±ç‰ŒåŒºåŸŸ */
        #community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            z-index: 100;
            min-width: 320px;
            min-height: 130px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #community-cards .card {
            margin: 0 2px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #community-cards .card:hover {
            transform: scale(1) translateY(-5px);
        }

        .role {
            position: absolute;
            width: 25px;
            height: 25px;
            top: -20px;
            right: -20px;
            background: linear-gradient(145deg, #ffd700, #ffed4a);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #fff;
            color: #000;
            font-size: 10px;
            z-index: 5;
        }

        #controls {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 15px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        #controls.active {
            display: flex;
            opacity: 1;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #333, #222);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button[onclick*="fold"] { background: linear-gradient(145deg, #d32f2f, #b71c1c); }
        button[onclick*="call"] { background: linear-gradient(145deg, #388e3c, #2e7d32); }
        button[onclick*="raise"] { background: linear-gradient(145deg, #1976d2, #1565c0); }

        .player-status {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: statusAppear 0.3s ease;
            z-index: 10;
            margin-top: 5px;
        }

        @keyframes statusAppear {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        #result-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #2c1810, #1a1a1a);
            color: white;
            border: 2px solid #ffd700;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            animation: modalPop 0.5s ease-out;
        }

        @keyframes modalPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .result-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .result-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,215,0,0.3);
        }

        .result-title {
            color: #ffd700;
            font-size: 28px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        .winner-info {
            background: rgba(255,215,0,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .winner-name {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .pot-amount {
            font-size: 18px;
            color: #fff;
            margin-bottom: 10px;
        }

        .hand-description {
            font-size: 16px;
            color: #aaa;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            margin-top: 10px;
        }

        .game-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-result {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .player-result:hover {
            transform: translateY(-5px);
        }

        .player-result.winner {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.2);
        }

        .player-result.folded {
            opacity: 0.6;
        }

        .player-name {
            font-size: 18px;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .player-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .player-status {
            font-size: 14px;
            color: #fff;
            margin-top: 5px;
        }

        .community-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .community-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,215,0,0.3);
        }

        .modal-buttons button {
            padding: 12px 30px;
            font-size: 18px;
            background: linear-gradient(145deg, #ffd700, #ffed4a);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c1810 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            transition: opacity 0.5s ease;
        }

        .game-title {
            color: #ffd700;
            font-size: 48px;
            margin-bottom: 50px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        }

        .difficulty-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            max-width: 600px;
        }

        .difficulty-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .difficulty-option:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffd700;
        }

        .difficulty-title {
            color: #ffd700;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .difficulty-description {
            color: #ffffff;
            font-size: 16px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .difficulty-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat {
            color: #ffffff;
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-icon {
            font-size: 18px;
        }

        /* æ·»åŠ è£…é¥°å…ƒç´  */
        .card-decoration {
            position: absolute;
            font-size: 120px;
            opacity: 0.1;
            color: #ffffff;
            pointer-events: none;
        }

        .card-decoration:nth-child(1) { top: 10%; left: 10%; transform: rotate(-15deg); }
        .card-decoration:nth-child(2) { top: 20%; right: 10%; transform: rotate(15deg); }
        .card-decoration:nth-child(3) { bottom: 10%; left: 15%; transform: rotate(10deg); }
        .card-decoration:nth-child(4) { bottom: 20%; right: 15%; transform: rotate(-10deg); }

        #bgm-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 50%;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 1000;
            font-size: 24px;
            color: #ffd700;
        }

        #bgm-control:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        #ai-speech {
            display: none;
            position: absolute;
            padding: 12px 16px;
            background: linear-gradient(145deg, #fff, #f8f8f8);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            font-size: 15px;
            font-weight: 500;
            min-width: 120px;
            max-width: 200px;
            text-align: center;
            z-index: 1001;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            animation: speechPop 0.3s ease-out;
            color: #000;
        }

        #ai-speech::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: #f8f8f8 transparent transparent;
        }

        @keyframes speechPop {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes speechOut {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
        }

        .red {
            color: #d32f2f;
            text-shadow: 0 0 2px rgba(211,47,47,0.3);
        }

        /* æ·»åŠ ç­¹ç å›¾æ ‡ */
        .chips::before {
            content: "ğŸ’°";
            margin-right: 5px;
        }

        /* æ·»åŠ ç‰Œæ¡Œçº¹ç† */
        #poker-table::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><rect width="20" height="20" fill="none"/><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
            border-radius: 50%;
            opacity: 0.3;
        }

        #player1 { 
            bottom: 2%;
            left: 50%;
            transform: translateX(-50%);
        }

        #player2 { 
            right: 2%;
            top: 50%;
            transform: translateY(-50%);
        }

        #player3 { 
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
        }

        #player4 { 
            left: 2%;
            top: 50%;
            transform: translateY(-50%);
        }

        .deck {
            position: absolute;
            right: 30%;
            top: 50%;
            transform: translateY(-50%);
        }

        .deck .card {
            position: absolute;
            margin-left: -48px;
        }

        .deck .card:nth-child(2) { transform: translateX(2px); }
        .deck .card:nth-child(3) { transform: translateX(4px); }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        #pot {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 101;
        }

        .round-info {
            position: fixed;
            top: 20px;
            right: 80px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 24px;
            color: #ffd700;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            transform: none;
            left: auto;
        }

        .coffee-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .coffee-section img {
            max-width: 300px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .coffee-section img:hover {
            transform: scale(1.05);
        }

        .coffee-text {
            color: #ffd700;
            font-size: 18px;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <div class="card-decoration">â™ </div>
        <div class="card-decoration">â™¥</div>
        <div class="card-decoration">â™£</div>
        <div class="card-decoration">â™¦</div>
        
        <h1 class="game-title">å¾·å·æ‰‘å…‹</h1>
        
        <div class="difficulty-container">
            <div class="difficulty-option" onclick="startGame('beginner')">
                <div class="difficulty-title">
                    <span class="difficulty-icon">ğŸŒŸ</span>
                    æ–°æ‰‹æ¨¡å¼
                </div>
                <div class="difficulty-description">
                    é€‚åˆåˆå­¦è€…ï¼ŒAIè¾ƒå¼±ï¼Œæ›´å®¹æ˜“è·èƒœã€‚å¼€å±€ç­¹ç æ›´å¤šï¼Œç›²æ³¨æ›´å°ã€‚
                </div>
                <div class="difficulty-stats">
                    <div class="stat">
                        <span class="stat-icon">ğŸ’°</span>
                        åˆå§‹ç­¹ç : 2000
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ²</span>
                        å°ç›²æ³¨: 5
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ¤–</span>
                        AIéš¾åº¦: ç®€å•
                    </div>
                </div>
            </div>

            <div class="difficulty-option" onclick="startGame('intermediate')">
                <div class="difficulty-title">
                    <span class="difficulty-icon">ğŸ†</span>
                    è¿›é˜¶æ¨¡å¼
                </div>
                <div class="difficulty-description">
                    æ ‡å‡†éš¾åº¦ï¼ŒAIå…·æœ‰æ­£å¸¸ç­–ç•¥æ ‡å‡†ç­¹ç å’Œç›²æ³¨è®¾ç½®ã€‚
                </div>
                <div class="difficulty-stats">
                    <div class="stat">
                        <span class="stat-icon">ğŸ’°</span>
                        åˆå§‹ç­¹ç : 1000
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ²</span>
                        å°ç›²æ³¨: 10
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ¤–</span>
                        AIéš¾åº¦: ä¸­ç­‰
                    </div>
                </div>
            </div>

            <div class="difficulty-option" onclick="startGame('professional')">
                <div class="difficulty-title">
                    <span class="difficulty-icon">ğŸ‘‘</span>
                    ä¸“ä¸šæ¨¡å¼
                </div>
                <div class="difficulty-description">
                    æŒ‘æˆ˜æ¨¡å¼ï¼ŒAIæ›´å…·ä¾µç•¥æ€§ã€‚åˆå§‹ç­¹ç æ›´å°‘ï¼Œç›²æ³¨æ›´å¤§ã€‚
                </div>
                <div class="difficulty-stats">
                    <div class="stat">
                        <span class="stat-icon">ğŸ’°</span>
                        åˆå§‹ç­¹ç : 500
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ²</span>
                        å°ç›²æ³¨: 20
                    </div>
                    <div class="stat">
                        <span class="stat-icon">ğŸ¤–</span>
                        AIéš¾åº¦: å›°éš¾
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-speech"></div>

    <div id="poker-table">
        <div id="community-cards"></div>
        <div id="pot">æ± åº•: 0</div>
        <div id="player1" class="player">
            <div class="name">ç©å®¶</div>
            <div class="chips">1000</div>
            <div class="cards"></div>
        </div>
        <div id="player2" class="player">
            <div class="name">ç–¯ç‹‚é©¬å…‹æ€</div>
            <div class="chips">1000</div>
            <div class="cards"></div>
        </div>
        <div id="player3" class="player">
            <div class="name">ç¨³å¥è€ç‹</div>
            <div class="chips">1000</div>
            <div class="cards"></div>
        </div>
        <div id="player4" class="player">
            <div class="name">è¯¡è®¡å¤šå¤š</div>
            <div class="chips">1000</div>
            <div class="cards"></div>
        </div>
        <div id="controls">
            <button onclick="playerAction('fold')">å¼ƒç‰Œ</button>
            <button onclick="playerAction('call')">è·Ÿæ³¨</button>
            <button onclick="playerAction('raise')">åŠ æ³¨</button>
        </div>
    </div>

    <div class="modal-overlay"></div>
    <div id="result-modal"></div>

    <div class="round-info">ç¬¬ 1 è½®</div>

    <div id="bgm-control" onclick="toggleBGM()">ğŸ”Š</div>

    <audio id="bgm" loop>
        <source src="https://cdn.freesound.org/previews/635/635476_14016667-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="card-shuffle">
        <source src="https://cdn.freesound.org/previews/523/523956_7724198-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="card-deal">
        <source src="https://cdn.freesound.org/previews/240/240777_4107740-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="chip-sound">
        <source src="https://cdn.freesound.org/previews/201/201806_3745836-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="fold-sound">
        <source src="https://cdn.freesound.org/previews/320/320181_5260872-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="win-sound">
        <source src="https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="ai-aggressive">
        <source src="https://cdn.freesound.org/previews/416/416479_5121236-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="ai-conservative">
        <source src="https://cdn.freesound.org/previews/157/157296_2538033-lq.mp3" type="audio/mp3">
    </audio>

    <audio id="ai-tricky">
        <source src="https://cdn.freesound.org/previews/434/434479_8386899-lq.mp3" type="audio/mp3">
    </audio>

    <script>
        class Card {
            constructor(suit, rank) {
                this.suit = suit;
                this.rank = rank;
            }

            toString() {
                const suits = {'â™ ': 'black', 'â™£': 'black', 'â™¥': 'red', 'â™¦': 'red'};
                const ranks = {
                    '14': 'A', '13': 'K', '12': 'Q', '11': 'J',
                    '10': '10', '9': '9', '8': '8', '7': '7',
                    '6': '6', '5': '5', '4': '4', '3': '3', '2': '2'
                };
                const rankText = ranks[this.rank];
                const suitClass = suits[this.suit];
                
                return `
                    <div class="${suitClass}">
                        <div class="rank">${rankText}</div>
                        <div class="suit">${this.suit}</div>
                        <div class="center-suit">${this.suit}</div>
                        <div class="rank-bottom">${rankText}</div>
                        <div class="suit-bottom">${this.suit}</div>
                    </div>
                `;
            }
        }

        class Player {
            constructor(name, type = 'human') {
                this.name = name;
                this.type = type;
                this.chips = 1000;
                this.cards = [];
                this.folded = false;
                this.currentBet = 0;
                this.lastAction = '';
            }

            reset() {
                this.cards = [];
                this.folded = false;
                this.currentBet = 0;
                this.lastAction = '';
            }
        }

        class SoundManager {
            constructor() {
                this.bgm = document.getElementById('bgm');
                this.cardShuffle = document.getElementById('card-shuffle');
                this.cardDeal = document.getElementById('card-deal');
                this.chipSound = document.getElementById('chip-sound');
                this.foldSound = document.getElementById('fold-sound');
                this.winSound = document.getElementById('win-sound');
                
                this.aiSounds = {
                    'aggressive': document.getElementById('ai-aggressive'),
                    'conservative': document.getElementById('ai-conservative'),
                    'tricky': document.getElementById('ai-tricky')
                };
                
                this.muted = false;
                this.volume = 0.5;
                
                // åˆå§‹åŒ–æ‰€æœ‰éŸ³é¢‘
                this.initializeAudio();
            }

            initializeAudio() {
                // è®¾ç½®èƒŒæ™¯éŸ³ä¹
                this.bgm.volume = 0.2;
                
                // è®¾ç½®éŸ³æ•ˆéŸ³é‡
                [this.cardShuffle, this.cardDeal, this.chipSound, 
                 this.foldSound, this.winSound].forEach(sound => {
                    sound.volume = this.volume;
                });
                
                // è®¾ç½®AIéŸ³æ•ˆéŸ³é‡
                Object.values(this.aiSounds).forEach(sound => {
                    sound.volume = this.volume * 0.6;
                });
            }

            fadeIn(audio, duration = 1000) {
                let volume = 0;
                audio.volume = volume;
                
                const interval = 50;
                const steps = duration / interval;
                const increment = audio.volume / steps;
                
                const fadeInterval = setInterval(() => {
                    volume = Math.min(volume + increment, this.volume);
                    audio.volume = volume;
                    
                    if (volume >= this.volume) {
                        clearInterval(fadeInterval);
                    }
                }, interval);
            }

            fadeOut(audio, duration = 1000) {
                let volume = audio.volume;
                
                const interval = 50;
                const steps = duration / interval;
                const decrement = volume / steps;
                
                const fadeInterval = setInterval(() => {
                    volume = Math.max(volume - decrement, 0);
                    audio.volume = volume;
                    
                    if (volume <= 0) {
                        clearInterval(fadeInterval);
                        audio.pause();
                    }
                }, interval);
            }

            async playBGM() {
                if (this.muted) return;
                this.bgm.currentTime = 0;
                this.bgm.volume = 0;
                await this.bgm.play();
                this.fadeIn(this.bgm, 2000);
            }

            async playShuffle() {
                if (this.muted) return;
                const sound = this.cardShuffle;
                sound.currentTime = 0;
                sound.volume = this.volume * 0.7;
                await sound.play();
                setTimeout(() => this.fadeOut(sound, 500), 1000);
            }

            async playDeal() {
                if (this.muted) return;
                const sound = this.cardDeal;
                sound.currentTime = 0;
                sound.volume = this.volume * 0.5;
                await sound.play();
            }

            async playChips() {
                if (this.muted) return;
                const sound = this.chipSound;
                sound.currentTime = 0;
                sound.volume = this.volume * 0.8;
                await sound.play();
            }

            async playFold() {
                if (this.muted) return;
                const sound = this.foldSound;
                sound.currentTime = 0;
                sound.volume = this.volume * 0.4;
                await sound.play();
            }

            async playWin() {
                if (this.muted) return;
                // æ·¡å‡ºèƒŒæ™¯éŸ³ä¹
                this.fadeOut(this.bgm, 1000);
                
                const sound = this.winSound;
                sound.currentTime = 0;
                sound.volume = 0;
                await sound.play();
                this.fadeIn(sound, 1000);
                
                // 3ç§’åæ·¡å‡ºèƒœåˆ©éŸ³æ•ˆï¼Œæ¢å¤èƒŒæ™¯éŸ³ä¹
                setTimeout(() => {
                    this.fadeOut(sound, 1000);
                    this.fadeIn(this.bgm, 1000);
                }, 3000);
            }

            async playAiSound(type) {
                if (this.muted) return;
                const sound = this.aiSounds[type];
                if (sound) {
                    sound.currentTime = 0;
                    sound.volume = this.volume * 0.4;
                    await sound.play();
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                
                const allSounds = [
                    this.bgm,
                    this.cardShuffle,
                    this.cardDeal,
                    this.chipSound,
                    this.foldSound,
                    this.winSound,
                    ...Object.values(this.aiSounds)
                ];
                
                allSounds.forEach(sound => {
                    sound.muted = this.muted;
                });
                
                document.getElementById('bgm-control').textContent = this.muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
            }

            setVolume(value) {
                this.volume = Math.max(0, Math.min(1, value));
                this.initializeAudio();
            }
        }

        let soundManager = new SoundManager();

        function toggleBGM() {
            soundManager.toggleMute();
        }

        class PokerHand {
            static getHandRank(cards) {
                // åˆå¹¶ç©å®¶æ‰‹ç‰Œå’Œå…¬å…±ç‰Œ
                const allCards = [...cards];
                
                // æ’åº
                allCards.sort((a, b) => b.rank - a.rank);
                
                // æ£€æŸ¥å„ç§ç‰Œå‹
                if (this.isRoyalFlush(allCards)) return { rank: 10, name: 'çš‡å®¶åŒèŠ±é¡º' };
                if (this.isStraightFlush(allCards)) return { rank: 9, name: 'åŒèŠ±é¡º' };
                if (this.isFourOfAKind(allCards)) return { rank: 8, name: 'å››æ¡' };
                if (this.isFullHouse(allCards)) return { rank: 7, name: 'è‘«èŠ¦' };
                if (this.isFlush(allCards)) return { rank: 6, name: 'åŒèŠ±' };
                if (this.isStraight(allCards)) return { rank: 5, name: 'é¡ºå­' };
                if (this.isThreeOfAKind(allCards)) return { rank: 4, name: 'ä¸‰æ¡' };
                if (this.isTwoPair(allCards)) return { rank: 3, name: 'ä¸¤å¯¹' };
                if (this.isOnePair(allCards)) return { rank: 2, name: 'ä¸€' };
                return { rank: 1, name: 'é«˜ç‰Œ' };
            }

            static isRoyalFlush(cards) {
                return this.isStraightFlush(cards) && cards[0].rank === 14;
            }

            static isStraightFlush(cards) {
                return this.isFlush(cards) && this.isStraight(cards);
            }

            static isFourOfAKind(cards) {
                const ranks = cards.map(c => c.rank);
                return new Set(ranks).size <= 4;
            }

            static isFullHouse(cards) {
                const rankCount = this.getRankCount(cards);
                return Object.values(rankCount).includes(3) && Object.values(rankCount).includes(2);
            }

            static isFlush(cards) {
                return new Set(cards.map(c => c.suit)).size === 1;
            }

            static isStraight(cards) {
                const ranks = [...new Set(cards.map(c => c.rank))].sort((a, b) => b - a);
                return ranks[0] - ranks[ranks.length - 1] === ranks.length - 1;
            }

            static isThreeOfAKind(cards) {
                const rankCount = this.getRankCount(cards);
                return Object.values(rankCount).includes(3);
            }

            static isTwoPair(cards) {
                const rankCount = this.getRankCount(cards);
                return Object.values(rankCount).filter(count => count === 2).length === 2;
            }

            static isOnePair(cards) {
                const rankCount = this.getRankCount(cards);
                return Object.values(rankCount).includes(2);
            }

            static getRankCount(cards) {
                const rankCount = {};
                cards.forEach(card => {
                    rankCount[card.rank] = (rankCount[card.rank] || 0) + 1;
                });
                return rankCount;
            }

            static getHandDescription(cards, handRank) {
                const ranks = {
                    '14': 'A', '13': 'K', '12': 'Q', '11': 'J',
                    '10': '10', '9': '9', '8': '8', '7': '7',
                    '6': '6', '5': '5', '4': '4', '3': '3', '2': '2'
                };

                let desc = `${handRank.name}ï¼š`;
                
                switch (handRank.rank) {
                    case 10:
                        desc += 'åŒèŠ±è‰²çš„AKQJ10';
                        break;
                    case 9:
                        const highCard = ranks[cards[0].rank];
                        desc += `${highCard}å¼€å¤´çš„åŒèŠ±é¡º`;
                        break;
                    case 8:
                        const fourRank = Object.entries(this.getRankCount(cards))
                            .find(([_, count]) => count === 4)[0];
                        desc += `å››ä¸ª${ranks[fourRank]}`;
                        break;
                    case 7:
                        const [threeRank] = Object.entries(this.getRankCount(cards))
                            .find(([_, count]) => count === 3)[0];
                        desc += `ä¸‰ä¸ª${ranks[threeRank]}å¸¦å¯¹å­`;
                        break;
                    case 6:
                        desc += `${cards[0].suit}èŠ±`;
                        break;
                    case 5:
                        desc += `${ranks[cards[0].rank]}é«˜çš„é¡ºå­`;
                        break;
                    case 4:
                        const tripleRank = Object.entries(this.getRankCount(cards))
                            .find(([_, count]) => count === 3)[0];
                        desc += `ä¸‰ä¸ª${ranks[tripleRank]}`;
                        break;
                    case 3:
                        const pairs = Object.entries(this.getRankCount(cards))
                            .filter(([_, count]) => count === 2)
                            .map(([rank, _]) => ranks[rank]);
                        desc += `${pairs[0]}å¯¹å’Œ${pairs[1]}å¯¹`;
                        break;
                    case 2:
                        const pairRank = Object.entries(this.getRankCount(cards))
                            .find(([_, count]) => count === 2)[0];
                        desc += `ä¸€å¯¹${ranks[pairRank]}`;
                        break;
                    case 1:
                        desc += `${ranks[cards[0].rank]}é«˜ç‰Œ`;
                        break;
                }
                
                return desc;
            }
        }

        class PokerGame {
            constructor(difficulty = 'intermediate') {
                this.difficulty = difficulty;
                this.players = [
                    new Player('ç©å®¶', 'human'),
                    new Player('ç–¯ç‹‚é©¬å…‹æ€', 'aggressive'),
                    new Player('ç¨³å¥è€ç‹', 'conservative'),
                    new Player('è¯¡è®¡å¤šå¤š', 'tricky')
                ];
                
                // æ ¹æ®éš¾åº¦è®¾ç½®é…ç½®
                switch(difficulty) {
                    case 'beginner':
                        this.initialChips = 2000;
                        this.smallBlind = 5;
                        break;
                    case 'professional':
                        this.initialChips = 500;
                        this.smallBlind = 20;
                        break;
                    default:
                        this.initialChips = 1000;
                        this.smallBlind = 10;
                }

                this.players.forEach(p => p.chips = this.initialChips);
                
                this.deck = [];
                this.communityCards = [];
                this.pot = 0;
                this.currentPlayer = 0;
                this.dealer = 0;
                this.currentBet = 0;
                this.round = 1;
                this.gameOver = false;
                this.initDeck();
                
                // å¼€å§‹èƒŒæ™¯éŸ³ä¹
                soundManager.playBGM();
            }

            initDeck() {
                const suits = ['â™ ', 'â™£', 'â™¥', 'â™¦'];
                const ranks = Array.from({length: 13}, (_, i) => i + 2);
                this.deck = [];
                for (let suit of suits) {
                    for (let rank of ranks) {
                        this.deck.push(new Card(suit, rank));
                    }
                }
            }

            shuffle() {
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
            }

            async startGame() {
                if (this.gameOver) {
                    return;
                }

                document.querySelector('.round-info').textContent = `ç¬¬ ${this.round} è½®`;
                
                this.initDeck();
                this.shuffle();
                this.pot = 0;
                this.communityCards = [];
                this.currentBet = 0;
                
                // Reset players
                this.players.forEach(p => p.reset());

                // æ’­æ”¾æ´—ç‰ŒéŸ³æ•ˆ
                soundManager.playShuffle();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Deal cards with sound
                for (let i = 0; i < 2; i++) {
                    for (let player of this.players) {
                        player.cards.push(this.deck.pop());
                        soundManager.playDeal();
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                // è®¾ç½®ä½ç½®ï¼ˆé€†æ—¶é’ˆé¡ºåºï¼‰
                this.dealer = (this.dealer + 1) % 4;  // åº„å®¶
                const sb = (this.dealer + 1) % 4;     // å°ç›²
                const bb = (this.dealer + 2) % 4;     // å¤§ç›²

                // å…ˆæ”¶å°ç›²æ³¨
                this.players[sb].chips -= this.smallBlind;
                this.players[sb].currentBet = this.smallBlind;
                soundManager.playChips();
                await new Promise(resolve => setTimeout(resolve, 500));

                // å†æ”¶å¤§ç›²æ³¨
                this.players[bb].chips -= this.smallBlind * 2;
                this.players[bb].currentBet = this.smallBlind * 2;
                soundManager.playChips();
                await new Promise(resolve => setTimeout(resolve, 500));

                this.pot = this.smallBlind * 3;
                this.currentBet = this.smallBlind * 2;

                this.updateUI();
                await this.playRound();
            }

            async playRound() {
                // Pre-flop
                await this.bettingRound();
                if (this.getActivePlayers().length > 1) {
                    // Flop
                    for (let i = 0; i < 3; i++) {
                        this.communityCards.push(this.deck.pop());
                    }
                    this.updateUI();
                    await this.bettingRound();
                }

                if (this.getActivePlayers().length > 1) {
                    // Turn
                    this.communityCards.push(this.deck.pop());
                    this.updateUI();
                    await this.bettingRound();
                }

                if (this.getActivePlayers().length > 1) {
                    // River
                    this.communityCards.push(this.deck.pop());
                    this.updateUI();
                    await this.bettingRound();
                }

                this.showdown();
            }

            getActivePlayers() {
                return this.players.filter(p => !p.folded);
            }

            async bettingRound() {
                if (this.communityCards.length === 0) {
                    // ç¬¬ä¸€è½®ï¼ˆç¿»ç‰Œå‰ï¼‰ï¼šä»å¤§ç›²ä¸‹å®¶å¼€å§‹
                    this.currentPlayer = (this.dealer + 3) % 4;
                } else {
                    // åç»­è½®æ¬¡ï¼šä»å°ç›²å¼€å§‹
                    this.currentPlayer = (this.dealer + 1) % 4;
                }

                let roundComplete = false;
                let lastRaisePlayer = null;
                let playersActed = 0;  // è®°å½•å·²è¡ŒåŠ¨çš„ç©å®¶æ•°
                
                while (!roundComplete) {
                    if (this.getActivePlayers().length === 1) break;

                    // æ›´æ–°UIå’ŒæŒ‰é’®çŠ¶æ€
                    this.updateUI();
                    this.updateControls();

                    // å¦‚æœç©å®¶å·²ç»å¼ƒç‰Œï¼Œè·³åˆ°ä¸‹ä¸€ä¸ªç©å®¶
                    if (this.players[this.currentPlayer].folded) {
                        this.currentPlayer = (this.currentPlayer + 1) % 4;
                        continue;
                    }

                    // ç¬¬ä¸€è½®ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿æ‰€æœ‰ç©å®¶éƒ½æœ‰æœºä¼šè¡ŒåŠ¨
                    if (this.communityCards.length === 0) {
                        if (playersActed >= this.getActivePlayers().length && 
                            this.checkBetsEqual()) {
                            break;
                        }
                    } else {
                        // å…¶ä»–è½®æ¬¡ï¼šå¦‚æœå›åˆ°æœ€ååŠ æ³¨è€…ä¸”æ‰€æœ‰ç©å®¶ä¸‹æ³¨ç›¸ç­‰ï¼Œç»“æŸè½®æ¬¡
                        if (lastRaisePlayer === this.currentPlayer && 
                            this.checkBetsEqual()) {
                            break;
                        }
                    }

                    if (this.players[this.currentPlayer].type === 'human') {
                        await new Promise(resolve => window.resolveAction = resolve);
                    } else {
                        await this.aiAction();
                    }

                    playersActed++;

                    if (this.players[this.currentPlayer].lastAction === 'raise') {
                        lastRaisePlayer = this.currentPlayer;
                    }

                    this.currentPlayer = (this.currentPlayer + 1) % 4;
                    roundComplete = this.checkRoundComplete();
                }

                this.hideControls();
            }

            checkBetsEqual() {
                const activePlayers = this.getActivePlayers();
                const bets = activePlayers.map(p => p.currentBet);
                return new Set(bets).size === 1;
            }

            async aiAction() {
                this.hideControls();
                
                const player = this.players[this.currentPlayer];
                document.getElementById(`player${this.currentPlayer + 1}`).classList.add('thinking');
                
                await new Promise(resolve => setTimeout(resolve, 2000));

                let action;
                const callAmount = this.currentBet - player.currentBet;
                
                // è°ƒæ•´AIç­–ç•¥çš„æ¿€è¿›ç¨‹åº¦
                let aggressiveChance, conservativeChance, trickyChance;
                let raiseMultiplier;  // åŠ æ³¨å€æ•°

                switch(this.difficulty) {
                    case 'beginner':
                        aggressiveChance = 0.6;  // æé«˜æ¿€è¿›æ¦‚ç‡
                        conservativeChance = 0.4;
                        trickyChance = 0.5;
                        raiseMultiplier = 3;  // åŠ æ³¨ä¸ºå°ç›²æ³¨çš„3å€
                        break;
                    case 'professional':
                        aggressiveChance = 0.9;  // éå¸¸æ¿€è¿›
                        conservativeChance = 0.3;
                        trickyChance = 0.8;
                        raiseMultiplier = 5;  // åŠ æ³¨ä¸ºå°ç›²æ³¨çš„5å€
                        break;
                    default:
                        aggressiveChance = 0.8;  // è¾ƒä¸ºæ¿€è¿›
                        conservativeChance = 0.35;
                        trickyChance = 0.7;
                        raiseMultiplier = 4;  // åŠ æ³¨ä¸ºå°ç›²æ³¨çš„4å€
                }
                
                // æ ¹æ®AIç±»å‹å†³å®šè¡ŒåŠ¨
                switch (player.type) {
                    case 'aggressive':
                        action = Math.random() < aggressiveChance ? 'raise' : 'call';
                        // é™ä½å¼ƒç‰Œæ¦‚ç‡
                        if (callAmount > player.chips * 0.7) {  // ä»0.5æ”¹ä¸º0.7
                            action = Math.random() < 0.3 ? 'fold' : 'call';  // 30%æ¦‚ç‡å¼ƒç‰Œ
                        }
                        break;
                    case 'conservative':
                        action = Math.random() < conservativeChance ? 'call' : 'raise';
                        if (callAmount > player.chips * 0.5) {
                            action = Math.random() < 0.4 ? 'fold' : 'call';  // 40%æ¦‚ç‡å¼ƒç‰Œ
                        }
                        break;
                    case 'tricky':
                        action = Math.random() < trickyChance ? 'raise' : 'call';
                        if (callAmount > player.chips * 0.6) {
                            action = Math.random() < 0.35 ? 'fold' : 'call';  // 35%æ¦‚ç‡å¼ƒç‰Œ
                        }
                        break;
                }

                // æ˜¾ç¤ºAIå¯¹è¯
                const speeches = {
                    'aggressive': {
                        'fold': [
                            'è¿™å±€å­è€å­ä¸è€äº†ï¼Œå¿’é»‘å’¯ï¼',
                            'è«å¾—æ„æ€ï¼Œæ’‚æ‹…å­ç®—å’¯ï¼',
                            'è¿™ç‰Œçƒ‚å¾—å¾ˆï¼Œä¸è€å’¯ï¼'
                        ],
                        'call': [
                            'å®‰é€¸ï¼Œè€å­è·Ÿåˆ°ï¼',
                            'è«æ…Œè«æ…Œï¼Œè·Ÿå°±è·Ÿå˜›ï¼',
                            'æœ‰å•¥å­å¥½æ€•çš„ï¼Œè·Ÿï¼'
                        ],
                        'raise': [
                            'åŠ æ³¨ï¼çœ‹ä½ ä»¬é¡¶ä¸é¡¶å¾—ä½ï¼',
                            'åŠ å¤§åŠ å¤§ï¼Œè«è¦æ€‚å˜›ï¼',
                            'è€å­å°±è¦åŠ æ³¨ï¼Œä½ ä»¬å’‹ä¸ªæ•´ï¼Ÿ'
                        ],
                        'check': [
                            'è¿‡å˜›è¿‡å˜›ï¼Œè«æ€¥ï¼',
                            'ç¨³ä½ç¨³ä½ï¼Œæ…¢æ…¢æ¥ï¼',
                            'çœ‹ä½ ä»¬å•·ä¸ªè€ï¼'
                        ],
                        'allin': [
                            'è€å­æ¢­å“ˆäº†ï¼æœ‰ç§è·Ÿåˆ°åº•ï¼',
                            'å…¨éƒ¨æŠ¼ä¸Šï¼Œå°±å¹²åˆ°åº•ï¼',
                            'çœ‹è€å­è¿™æ¬¡è±å‡ºå»äº†ï¼'
                        ]
                    },
                    'conservative': {
                        'fold': [
                            'è¿™å±€å­ä¸å®‰é€¸ï¼Œç®—å’¯ï¼',
                            'å½¢ä¸å¦™ï¼Œè«è€å’¯ï¼',
                            'è¿™ç‰Œé¢ä¸å¾—è¡Œï¼Œæ­‡ä¼šå„¿ï¼'
                        ],
                        'call': [
                            'è·Ÿå°±è·Ÿå˜›ï¼Œè«ç€æ€¥ï¼',
                            'å®‰é€¸ï¼Œæ…¢æ…¢è€ï¼',
                            'å¦¥ç‚¹ï¼Œè·Ÿä½ï¼'
                        ],
                        'raise': [
                            'åŠ æ³¨ï¼Œä½ ä»¬è¦æƒ³æ¸…æ¥šå“¦ï¼',
                            'åŠ ç‚¹ç­¹ï¼Œè«è¦ä¹±æŠ•',
                            'åŠ æ³¨ï¼Œä½ ä»¬è¦ä¸‰æ€å“¦ï¼'
                        ],
                        'check': [
                            'ç¨³ä½ç¨³ä½ï¼Œè«æ…Œï¼',
                            'è¿‡ç‰Œï¼Œçœ‹ä½ ä»¬å’‹ä¸ªè€ï¼',
                            'æ…¢æ…¢æ¥ï¼Œè«æ€¥ï¼'
                        ],
                        'allin': [
                            'è¿™æŠŠå€¼å¾—æ¢­å“ˆï¼',
                            'ç ´é‡œæ²‰èˆŸï¼Œå…¨éƒ¨æŠ¼ä¸Šï¼',
                            'è±å‡ºå»äº†ï¼Œå…¨ä¸‹ï¼'
                        ]
                    },
                    'tricky': {
                        'fold': [
                            'è¿™å±€å­ä¸è€å’¯ï¼Œä¸‹æ¬¡å†æ•´ï¼',
                            'ä»Šå¤©è¿æ°”ä¸å¾—è¡Œï¼Œç®—å’¯ï¼',
                            'è«å¾—æ„æ€ï¼Œæ’¤å’¯ï¼'
                        ],
                        'call': [
                            'æœ‰æ„æ€ï¼Œè·Ÿåˆ°åº•ï¼',
                            'çœ‹ä½ ä»¬å•·ä¸ªè€ï¼Œè·Ÿäº†ï¼',
                            'è«è¦ä»¥ä¸ºæˆ‘ä¸æ™“å¾—ä½ ä»¬åœ¨æ•´å•¥å­ï¼'
                        ],
                        'raise': [
                            'åŠ æ³¨ï¼ä½ ä»¬çŒœæˆ‘æ˜¯ä¸æ˜¯åœ¨è™šå¼ å£°åŠ¿ï¼Ÿ',
                            'è¦å¾—è¦å¾—ï¼ŒåŠ å¤§ç‚¹ï¼',
                            'åŠ æ³¨ï¼çœ‹ä½ ä»¬æ•¢ä¸æ•¢è·Ÿï¼'
                        ],
                        'check': [
                            'å…ˆè¿‡ç€ï¼Œè«è¦ç€æ€¥ï¼',
                            'çœ‹ä½ ä»¬å•·ä¸ªè€å˜›ï¼',
                            'æ…¢æ…¢æ¥ï¼Œæœ‰çš„æ˜¯æ—¶é—´ï¼'
                        ],
                        'allin': [
                            'è¦å¾—ï¼Œè€å­æ¢­å“ˆäº†ï¼',
                            'å…¨éƒ¨æŠ¼ä¸Šï¼Œä½ ä»¬æ•¢ä¸æ•¢ï¼Ÿ',
                            'çœ‹æˆ‘è¿™æ¬¡ç©è¿™ä¹ˆå¤§ï¼'
                        ]
                    }
                };

                const actionType = callAmount === 0 && action === 'call' ? 'check' : action;
                const aiType = player.type;
                const speechList = speeches[aiType][actionType];
                const speech = speechList[Math.floor(Math.random() * speechList.length)];

                this.showAiSpeech(player.name, speech);

                document.getElementById(`player${this.currentPlayer + 1}`).classList.remove('thinking');

                player.lastAction = action;
                
                switch (action) {
                    case 'fold':
                        player.folded = true;
                        soundManager.playFold();
                        break;
                    case 'call':
                        if (callAmount === 0) {
                            player.lastAction = 'check';
                        }
                        this.pot += callAmount;
                        player.chips -= callAmount;
                        player.currentBet = this.currentBet;
                        soundManager.playChips();
                        break;
                    case 'raise':
                        // å¢åŠ åŠ æ³¨é‡‘é¢
                        const raiseAmount = Math.min(
                            player.chips,
                            this.currentBet + this.smallBlind * raiseMultiplier  // ä½¿ç”¨æ–°çš„åŠ æ³¨å€æ•°
                        );
                        this.pot += raiseAmount;
                        player.chips -= raiseAmount;
                        this.currentBet = player.currentBet = raiseAmount;
                        soundManager.playChips();
                        break;
                    case 'allin':
                        const allinAmount = player.chips;
                        this.pot += allinAmount;
                        player.chips = 0;
                        player.currentBet += allinAmount;
                        if (player.currentBet > this.currentBet) {
                            this.currentBet = player.currentBet;
                        }
                        soundManager.playChips();
                        break;
                }

                this.updateUI();
            }

            checkRoundComplete() {
                const activePlayers = this.getActivePlayers();
                if (activePlayers.length === 1) return true;

                // æ£€æŸ¥æ‰€æœ‰æœªå¼ƒç‰Œçš„ç©å®¶ä¸‹æ³¨æ˜¯å¦ç›¸ç­‰
                const bets = activePlayers.map(p => p.currentBet);
                return new Set(bets).size === 1 && bets[0] === this.currentBet;
            }

            showdown() {
                this.hideControls();
                
                let result = `
                    <div class="result-content">
                        <div class="result-header">
                            <h2 class="result-title">æœ¬å±€ç»“ç®—</h2>
                        </div>
                `;

                const activePlayers = this.getActivePlayers();
                let winner, winnerHand;

                if (activePlayers.length === 1) {
                    winner = activePlayers[0];
                    winner.chips += this.pot;
                    result += `
                        <div class="winner-info">
                            <div class="winner-name">${winner.name}</div>
                            <div class="pot-amount">è·å¾—ç­¹ç : ${this.pot}</div>
                            <div class="hand-description">å…¶ä»–ç©å®¶å·²å¼ƒç‰Œ</div>
                        </div>
                    `;
                } else {
                    const playerHands = activePlayers.map(player => {
                        const availableCards = [...player.cards, ...this.communityCards];
                        const handRank = PokerHand.getHandRank(availableCards);
                        return {
                            player,
                            handRank,
                            description: PokerHand.getHandDescription(availableCards, handRank)
                        };
                    });

                    playerHands.sort((a, b) => b.handRank.rank - a.handRank.rank);
                    winner = playerHands[0].player;
                    winnerHand = playerHands[0];
                    winner.chips += this.pot;

                    result += `
                        <div class="winner-info">
                            <div class="winner-name">${winner.name}</div>
                            <div class="pot-amount">è·å¾—ç­¹ç : ${this.pot}</div>
                            <div class="hand-description">${winnerHand.description}</div>
                        </div>
                    `;
                }

                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                const gameOverStatus = this.checkGameOver();
                if (gameOverStatus.isOver) {
                    result += `
                        <div class="game-over-info" style="margin: 20px 0; padding: 20px; background: rgba(255,0,0,0.1); border-radius: 10px;">
                            <h3 style="color: #ff4444; margin-bottom: 10px;">æ¸¸æˆç»“æŸ</h3>
                            <div>æœ€ç»ˆè·èƒœè€…: ${gameOverStatus.winner.name}</div>
                            <div>è·èƒœç­¹ç : ${gameOverStatus.winner.chips}</div>
                            <div style="margin-top: 10px;">
                                ç ´äº§ç©å®¶: ${gameOverStatus.bankruptPlayers.map(p => p.name).join(', ')}
                            </div>
                        </div>
                    `;
                }

                result += '<div class="game-summary">';
                this.players.forEach(player => {
                    const isWinner = player === winner;
                    const handRank = player.folded ? null : PokerHand.getHandRank([...player.cards, ...this.communityCards]);
                    
                    result += `
                        <div class="player-result ${isWinner ? 'winner' : ''} ${player.folded ? 'folded' : ''}">
                            <div class="player-name">${player.name}</div>
                            <div class="player-cards">
                                ${player.cards.map(card => 
                                    `<div class="card">${card.toString()}</div>`
                                ).join('')}
                            </div>
                            <div class="player-status">
                                ${player.folded ? 
                                    '<span class="fold-tag">å·²å¼ƒç‰Œ</span>' : 
                                    `<span class="hand-type">${handRank.name}</span>`
                                }
                                <div class="chips-amount">å½“å‰ç­¹ç : ${player.chips}</div>
                            </div>
                        </div>
                    `;
                });
                result += '</div>';

                if (this.communityCards.length > 0) {
                    result += `
                        <div class="community-section">
                            <div class="section-title">å…¬å…±ç‰Œ</div>
                            <div class="community-cards">
                                ${this.communityCards.map(card => 
                                    `<div class="card">${card.toString()}</div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                result += `
                    <div class="modal-buttons">
                        ${gameOverStatus.isOver ? 
                            `<button onclick="restartGame()">é‡æ–°å¼€å§‹</button>` :
                            `<button onclick="continueGame()">ç»§ç»­æ¸¸æˆ</button>`
                        }
                    </div>
                </div>`;

                const modal = document.getElementById('result-modal');
                const overlay = document.querySelector('.modal-overlay');
                
                modal.innerHTML = result;
                modal.style.display = 'block';
                overlay.style.display = 'block';
                
                soundManager.playWin();

                // å¦‚æœæ¸¸æˆç»“æŸï¼Œé˜»æ­¢ç»§ç»­æ¸¸æˆ
                if (gameOverStatus.isOver) {
                    this.gameOver = true;
                }
            }

            updateUI() {
                // æ›´æ–°æ± åº•æ˜¾ç¤º
                document.getElementById('pot').textContent = `æ± åº•: ${this.pot}`;

                // æ›´æ–°å…¬å…±ç‰Œ
                const communityCardsDiv = document.getElementById('community-cards');
                communityCardsDiv.innerHTML = this.communityCards.map(card => 
                    `<div class="card">${card.toString()}</div>`
                ).join('');

                // æ›´æ–°ç©å®¶
                this.players.forEach((player, index) => {
                    const playerDiv = document.getElementById(`player${index + 1}`);
                    playerDiv.querySelector('.chips').textContent = player.chips;
                    
                    const cardsDiv = playerDiv.querySelector('.cards');
                    if (index === 0 || player.folded) {
                        // æ˜¾ç¤ºç©å®¶è‡ªå·±çš„ç‰Œæˆ–å¼ƒç‰Œçš„ç‰Œ
                        cardsDiv.innerHTML = player.cards.map(card => 
                            `<div class="card">${card.toString()}</div>`
                        ).join('');
                    } else {
                        // æ˜¾ç¤ºå…¶ä»–ç©å®¶çš„ç‰ŒèƒŒ
                        cardsDiv.innerHTML = player.cards.map(() => 
                            `<div class="card back"></div>`
                        ).join('');
                    }

                    if (player.folded) {
                        playerDiv.classList.add('folded');
                    } else {
                        playerDiv.classList.remove('folded');
                    }

                    // ç§»é™¤æ—§çš„çŠ¶æ€æ˜¾ç¤º
                    const oldStatus = playerDiv.querySelector('.player-status');
                    if (oldStatus) {
                        oldStatus.remove();
                    }

                    // æ·»åŠ æ–°çš„çŠ¶æ€æ˜¾ç¤º
                    if (player.folded || player.lastAction) {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'player-status';
                        
                        if (player.folded) {
                            statusDiv.classList.add('status-fold');
                            statusDiv.textContent = 'å·²å¼ƒç‰Œ';
                        } else if (player.lastAction) {
                            const actionText = {
                                'fold': 'å¼ƒç‰Œ',
                                'call': 'è·Ÿæ³¨',
                                'raise': 'åŠ æ³¨',
                                'check': 'è¿‡ç‰Œ'
                            };
                            statusDiv.classList.add(`status-${player.lastAction}`);
                            statusDiv.textContent = actionText[player.lastAction];
                            if (player.currentBet > 0) {
                                statusDiv.textContent += ` ${player.currentBet}`;
                            }
                        }
                        
                        playerDiv.appendChild(statusDiv);
                    }
                });

                // Update positions
                const positions = ['åº„å®¶', 'å°ç›²', 'å¤§ç›²'];
                document.querySelectorAll('.role').forEach(el => el.remove());
                
                for (let i = 0; i < 3; i++) {
                    const position = (this.dealer + i) % 4;
                    const playerDiv = document.getElementById(`player${position + 1}`);
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role';
                    roleDiv.textContent = positions[i];
                    playerDiv.appendChild(roleDiv);
                }
            }

            showAiSpeech(name, text) {
                const playerDiv = document.getElementById(`player${this.currentPlayer + 1}`);
                const speechDiv = document.createElement('div');
                speechDiv.id = 'ai-speech';
                speechDiv.textContent = text;
                
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¯¹è¯æ¡†
                const oldSpeech = playerDiv.querySelector('#ai-speech');
                if (oldSpeech) {
                    oldSpeech.remove();
                }

                // æ·»åŠ åˆ°ç©å®¶divä¸­
                playerDiv.appendChild(speechDiv);
                
                // æ˜¾ç¤ºå¯¹è¯æ¡†
                speechDiv.style.display = 'block';

                // 2ç§’åç§»é™¤
                setTimeout(() => {
                    speechDiv.style.animation = 'speechOut 0.3s ease-out';
                    setTimeout(() => {
                        speechDiv.remove();
                    }, 300);
                }, 2000);
            }

            checkGameOver() {
                const bankruptPlayers = this.players.filter(p => p.chips <= 0);
                if (bankruptPlayers.length > 0) {
                    this.gameOver = true;
                    // æ‰¾å‡ºè·èƒœè€…ï¼ˆç­¹ç æœ€å¤šçš„ç©å®¶ï¼‰
                    const winner = this.players.reduce((prev, current) => 
                        (prev.chips > current.chips) ? prev : current
                    );
                    return {
                        isOver: true,
                        winner: winner,
                        bankruptPlayers: bankruptPlayers
                    };
                }
                return { isOver: false };
            }

            showCoffeeModal() {
                return new Promise(resolve => {
                    const modal = document.getElementById('result-modal');
                    const overlay = document.querySelector('.modal-overlay');
                    
                    const content = `
                        <div class="result-content">
                            <div class="result-header">
                                <h2 class="result-title">è¯·æˆ‘å–æ¯å’–å•¡å§ â˜•</h2>
                            </div>
                            <div class="coffee-section">
                                <div class="coffee-text">å–œæ¬¢è¿™ä¸ªæ¸¸æˆå—ï¼Ÿæ”¯æŒä¸€ä¸‹å¼€å‘è€…å§~</div>
                                <img src="https://s21.ax1x.com/2024/11/15/pA2C6nx.jpg" alt="Buy me a coffee">
                                <div class="coffee-text" style="font-size: 14px; color: #aaa; margin-top: 10px;">
                                    æ‰«ç èµèµï¼Œæ”¯æŒæ¸¸æˆæŒç»­æ›´æ–° ğŸ’
                                </div>
                            </div>
                            <div class="modal-buttons">
                                <button onclick="closeCoffeeModal()">ç»§ç»­æ¸¸æˆ</button>
                            </div>
                        </div>
                    `;
                    
                    modal.innerHTML = content;
                    modal.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    window.coffeeModalResolve = resolve;
                });
            }

            async continueGame() {
                if (this.gameOver) {
                    return;
                }

                this.round++;

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå’–å•¡å¼¹çª—
                if (this.round === 2 || this.round % 10 === 0) {
                    const modal = document.getElementById('result-modal');
                    const overlay = document.querySelector('.modal-overlay');
                    modal.style.display = 'none';
                    overlay.style.display = 'none';

                    // ç­‰å¾…å’–å•¡å¼¹çª—å…³é—­
                    await this.showCoffeeModal();
                }

                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.pot = 0;
                this.communityCards = [];
                this.currentBet = 0;
                this.players.forEach(p => p.reset());
                
                const modal = document.getElementById('result-modal');
                const overlay = document.querySelector('.modal-overlay');
                modal.style.display = 'none';
                overlay.style.display = 'none';

                this.startGame();
            }

            // æ–°å¢ï¼šæ›´æ–°æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateControls() {
                const controls = document.getElementById('controls');
                if (this.currentPlayer === 0 && !this.players[0].folded) {
                    controls.classList.add('active');
                    
                    const player = this.players[0];
                    const callAmount = this.currentBet - player.currentBet;
                    const raiseAmount = Math.min(
                        player.chips,
                        this.currentBet + this.smallBlind * 2
                    );
                    
                    // å¦‚æœç©å®¶ç­¹ç ä¸å¤Ÿè·Ÿæ³¨ï¼Œåªæ˜¾ç¤º allin å’Œå¼ƒç‰Œé€‰é¡¹
                    if (callAmount >= player.chips) {
                        controls.innerHTML = `
                            <button onclick="playerAction('fold')">å¼ƒç‰Œ</button>
                            <button onclick="playerAction('allin')" style="background: linear-gradient(145deg, #ff9800, #f57c00);">å…¨ä¸‹ ${player.chips}</button>
                        `;
                    } else {
                        controls.innerHTML = `
                            <button onclick="playerAction('fold')">å¼ƒç‰Œ</button>
                            <button onclick="playerAction('call')">${callAmount === 0 ? 'è¿‡ç‰Œ' : 'è·Ÿæ³¨ ' + callAmount}</button>
                            <button onclick="playerAction('raise')">åŠ æ³¨ ${raiseAmount}</button>
                            <button onclick="playerAction('allin')" style="background: linear-gradient(145deg, #ff9800, #f57c00);">å…¨ä¸‹ ${player.chips}</button>
                        `;
                    }
                } else {
                    controls.classList.remove('active');
                }
            }

            // æ–°å¢ï¼šéšè—æ§åˆ¶æŒ‰é’®
            hideControls() {
                const controls = document.getElementById('controls');
                controls.classList.remove('active');
            }
        }

        let game;

        function startGame(difficulty) {
            const startScreen = document.getElementById('start-screen');
            startScreen.style.opacity = '0';
            setTimeout(() => {
                startScreen.style.display = 'none';
                startScreen.style.opacity = '1';
                game = new PokerGame(difficulty);
                game.startGame();
            }, 500);
        }

        function playerAction(action) {
            if (game.currentPlayer !== 0) return;

            const player = game.players[0];
            const callAmount = game.currentBet - player.currentBet;

            player.lastAction = action;
            if (action === 'call' && callAmount === 0) {
                player.lastAction = 'check';
            }

            switch (action) {
                case 'allin':
                    const allinAmount = player.chips;
                    game.pot += allinAmount;
                    player.chips = 0;
                    player.currentBet += allinAmount;
                    if (player.currentBet > game.currentBet) {
                        game.currentBet = player.currentBet;
                    }
                    soundManager.playChips();
                    break;
                case 'fold':
                    player.folded = true;
                    soundManager.playFold();
                    break;
                case 'call':
                    if (callAmount <= player.chips) {
                        game.pot += callAmount;
                        player.chips -= callAmount;
                        player.currentBet = game.currentBet;
                        soundManager.playChips();
                    }
                    break;
                case 'raise':
                    const raiseAmount = Math.min(
                        player.chips,
                        game.currentBet + game.smallBlind * 2
                    );
                    game.pot += raiseAmount;
                    player.chips -= raiseAmount;
                    game.currentBet = player.currentBet = raiseAmount;
                    soundManager.playChips();
                    break;
            }

            game.updateUI();  // ç«‹å³æ›´æ–°æ˜¾ç¤º
            window.resolveAction();
        }

        function continueGame() {
            game.continueGame();
        }

        function restartGame() {
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('result-modal').style.display = 'none';
            document.querySelector('.modal-overlay').style.display = 'none';
            game = null; // æ¸…é™¤å½“å‰æ¸¸æˆå®ä¾‹
        }

        // æ·»åŠ å…³é—­å’–å•¡å¼¹çª—çš„å‡½æ•°
        function closeCoffeeModal() {
            const modal = document.getElementById('result-modal');
            const overlay = document.querySelector('.modal-overlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
            
            if (window.coffeeModalResolve) {
                window.coffeeModalResolve();
                window.coffeeModalResolve = null;
            }
        }
    </script>
</body>
</html> 